<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Poly Books</title>
    <link rel="icon" type="image/x-icon" href="assets/img/polyBooks.png" />

    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />

    <link href="css/styles.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="assets/img/logobook.png" />
    <script data-search-pseudo-elements defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/js/all.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body class="nav-fixed">
{{> nav_header}}
<div id="layoutSidenav">
    <!--            Sidebar-->
    {{> sidebar}}
    <!--            End Sidebar-->

    <!--          Start Content-->

    <div id="layoutSidenav_content">
        <main>
            <div class="mx-2 pt-2">
                <div class="card h-auto">
                    <div class="card-header">
                        <div class="dropdown mb-2">
                            <button class="btn btn-light dropdown-toggle" id="dropdownButton" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Hôm nay</button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <a class="dropdown-item" id="today-option" onclick="updateData('today')">Hôm nay</a>
                                <a class="dropdown-item" id="week-option" onclick="updateData('week')">Tuần trước</a>
                                <a class="dropdown-item" id="month-option" onclick="updateData('month')">Tháng trước</a>
                            </div>
                        </div>
                        <div class="">
                            <div class="row">
                                <div class="col-sm  mb-2">
                                    <!-- Dashboard info Tai khoan moi-->
                                    <div class="card border-start-lg border-start-primary h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="uppercase fw-bold text-primary mb-3">Tài khoản mới</div>
                                                    <div class="row">
                                                        <div class="col-3"><i class="fas fa-solid fa-user fa-lg text-gray-200"></i></div>
                                                        <div id="dataDisplay" class="col-6 ml-1 h5 mt-1"></div>
                                                    </div>
                                                </div>
                                                <!--                                                <div class="ms-2"><i class="fas fa-solid fa-user fa-2x text-gray-200"></i></div>-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm mb-2">
                                    <!-- Dashboard info Cua hang moi-->
                                    <div class="card border-start-lg border-start-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="uppercase fw-bold text-success mb-3">Cửa hàng mới</div>
                                                    <div class="row">
                                                        <div class="col-3"><i class="fas fa-solid fa-shop fa-lg text-gray-200"></i></div>
                                                        <div id="shop-count" class="col-6 h5 mt-1"></div>
                                                    </div>

                                                </div>
                                                <!--                                                <div class="ms-2"><i class="fas fa-solid fa-shop fa-2x text-gray-200"></i></div>-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm mb-2">
                                    <!-- Dashboard info Tai khoan moi-->
                                    <div class="card border-start-lg border-start-danger h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="uppercase fw-bold text-danger mb-3">Sách mới đăng</div>
                                                    <div class="row">
                                                        <div class="col-3"><i class="fas fa-solid fa-book fa-lg text-gray-200"></i></div>
                                                        <div id="post-count" class="col-6 h5 mt-1"></div>
                                                    </div>

                                                </div>
                                                <!--                                                <div class="ms-2"><i class="fas fa-solid fa-check fa-2x text-gray-200"></i></div>-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm  mb-2">
                                    <!-- Dashboard info Tai khoan moi-->
                                    <div class="card border-start-lg border-start-info h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="uppercase fw-bold text-info mb-3">Đơn gửi đi</div>
                                                    <div class="row">
                                                        <div class="col-3"><i class="fas fa-solid fa-truck-fast fa-lg text-gray-200"></i></div>
                                                        <div id="send-bill-count" class="col-6 h5 mt-1"></div>
                                                    </div>

                                                </div>
                                                <!--                                                <div class="ms-2"><i class="fas fa-solid fa-truck-fast fa-2x text-gray-200"></i></div>-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm  mb-2">
                                    <!-- Dashboard info Tai khoan moi-->
                                    <div class="card border-start-lg border-start-warning h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="uppercase fw-bold text-warning mb-3">Đơn hoàn thành</div>
                                                    <div class="row">
                                                        <div class="col-3"><i class="fas fa-solid fa-check fa-lg text-gray-200"></i></div>
                                                        <div id="complete-bill-count" class="col-6 h5 mt-1"></div>
                                                    </div>
                                                </div>
                                                <!--                                                <div class="ms-2"><i class="fas fa-solid fa-check fa-2x text-gray-200"></i></div>-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mx-2 pt-4">
                <div class="col-xl-6 mb-4">
                    <div class="card card-header-actions h-100">
                        <div class="card-header">
                            Sách
                        </div>
                        <div class="card-body">
                            <canvas id="BookGroupedbarChartcanvas" width="100%" height="50%"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-xl-6 mb-4">
                    <div class="card card-header-actions h-100">
                        <div class="card-header">
                            Đơn hàng
                        </div>
                        <div class="card-body">
                            <div class="chart-bar">
                                <canvas id="DonHang" width="100%" height="50%"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="row mx-2 pt-4">
                <div class="col-xl-8 mb-4">
                    <div class="card ">
                        <div class="card-header">Thể loại bán chạy nhất</div>
                        <div class="card-body">
                            <table id="datatablesSimple">
                                <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>ID</th>
                                    <th>Tên thể loại</th>
                                    <th>Số lượng</th>
                                </tr>
                                </thead>
                                <tbody>
                                    {{#each categoryCounts}}
                                <tr>
                                    <td id="index{{@index}}"></td>
                                    <td>{{this._id}}</td>
                                    <td>{{this.name}}</td>
                                    <td>{{this.count}}</td>
                                </tr>
                                    {{/each}}
                                </tbody>
                            </table>
                            <script>
                                const tdElements = document.querySelectorAll('td[id^="index"]');
                                tdElements.forEach((td, index) => {
                                    td.textContent = index + 1;
                                });
                            </script>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 mb-4">
                    <!-- Pie chart with legend example-->
                    <div class="card h-100">
                        <div class="card-header">Người dùng</div>
                        <div class="card-body">
                            
                            <div class="chart-pie mb-4 d-flex justify-content-center align-items-center">
                                <canvas id="myPieChart" width="100%" height="50"></canvas>
                            </div>
                           
                            
                            
                            <div class="mt-4 list-group list-group-flush">
                                <div class="list-group-item d-flex align-items-center justify-content-between small px-0 py-2">
                                    <div class="me-3">
                                        <i class="fas fa-circle fa-sm me-1 text-blue"></i>
                                        Người dùng thường
                                    </div>
                                    <div id="count-regularUser" class="fw-500 text-dark" ></div>
                                </div>
                                <div class="list-group-item d-flex align-items-center justify-content-between small px-0 py-2">
                                    <div class="me-3">
                                        <i class="fas fa-circle fa-sm me-1 text-green"></i>
                                        Người dùng VIP
                                    </div>
                                    <div id="count-vipUser" class="fw-500 text-dark"></div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    let dataToDisplay = "today"; // Default option is "Hôm nay"

    // Function to update the displayed data based on the selected option
    async function updateData(option) {
        dataToDisplay = option;
        
        
        const response = await fetch(`{{this.urls.ADD_USER_URL}}`);
        
        
        const data = await response.json();
        const statisticalToday = data.statisticalToday;
        const statisticalWeek = data.statisticalWeek;
        const statisticalMonth = data.statisticalMonth;

        let dataToDisplayValue;
        let shopToDisplayValue;
        let postToDisplayValue;
        let sendBillToDisplayValue;
        let completeBillToDisplayValue;

        if (dataToDisplay === "today") {
            dataToDisplayValue = statisticalToday.userToday;
            shopToDisplayValue = statisticalToday.shopToday;
            postToDisplayValue = statisticalToday.postToday;
            sendBillToDisplayValue = statisticalToday.sendBillsToday;
            completeBillToDisplayValue = statisticalToday.completeBillsToday;
        } else if (dataToDisplay === "week") {
            dataToDisplayValue = statisticalWeek.userWeek;
            shopToDisplayValue = statisticalWeek.shopWeek;
            postToDisplayValue = statisticalWeek.postWeek;
            sendBillToDisplayValue = statisticalWeek.sendBillsWeek;
            completeBillToDisplayValue = statisticalWeek.completeBillsWeek;
        } else if (dataToDisplay === "month") {
            dataToDisplayValue = statisticalMonth.userMonth;
            shopToDisplayValue = statisticalMonth.shopMonth;
            postToDisplayValue = statisticalMonth.postMonth;
            sendBillToDisplayValue = statisticalMonth.sendBillsMonth;
            completeBillToDisplayValue = statisticalMonth.completeBillsMonth;
        } else {
            // Handle invalid option here if needed
            return;
        }

        // Update user count in the "dataDisplay" div
        const dataDisplay = document.getElementById('dataDisplay');
        dataDisplay.textContent = dataToDisplayValue;

        const shopCount = document.getElementById('shop-count');
        shopCount.textContent = shopToDisplayValue;

        // Update post count in the "shop-count" div
        const postCount = document.getElementById('post-count');
        postCount.textContent = postToDisplayValue;

        const sendBillCount = document.getElementById('send-bill-count');
        sendBillCount.textContent = sendBillToDisplayValue;

        const completeBillCount = document.getElementById('complete-bill-count');
        completeBillCount.textContent = completeBillToDisplayValue;

        // Update the dropdown button text based on the selected option
        const dropdownButton = document.getElementById('dropdownButton');
        dropdownButton.textContent = option === "today" ? "Hôm nay" : option === "week" ? "Tuần trước" : "Tháng trước";
        
    }

    // Initial data display on page load
    updateData(dataToDisplay);
</script>

<script>
    let regularUserPercentage
    let vipUserPercentage
    let regularUsers
    let vipUsers
    async function getUserData() {
        
        const response = await fetch(`{{this.urls.GET_USER_VIP_URL}}`);
        const data = await response.json();
        regularUserPercentage = data.regularUserPercentage
        vipUserPercentage = data.vipUserPercentage
        regularUsers = data.regularUsers
        vipUsers = data.vipUsers
        // Lấy canvas element và khởi tạo biểu đồ pie chart

    }
    getUserData().then((value)=>{
        const Userctx = document.getElementById("myPieChart").getContext("2d");
        new Chart(Userctx, {
            type: "doughnut",
            data: {
                labels: ["Người dùng thường(%)", "Người dùng VIP(%)"],
                datasets: [{
                    data: [regularUserPercentage, vipUserPercentage],
                    backgroundColor: ["#007bff", "#28a745"],
                }],
            },
            options: {
                maintainAspectRatio: false,
                tooltips: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyFontColor: "#858796",
                    borderColor: "#dddfeb",
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10
                },
                cutoutPercentage: 75
            }
        });

        const regularUsersCount = document.getElementById('count-regularUser');
        const vipUsersCount = document.getElementById('count-vipUser');

        regularUsersCount.textContent = regularUsers;
        vipUsersCount.textContent = vipUsers;

    })

</script>

<script>
    function formatDate(dateStr) {
        const [day, month, year] = dateStr.split('/');
        return `${day}/${month}`;
    }

    let labels;
    let dataRegularBook;
    let dataAuctionBook;
    let dataBill;
    let dataThreeBill; // Biến để lưu trữ dữ liệu đơn hoàn thành
    var GroupedbarChartData;

    async function getRegularAndAuctionBookData() {
        const responseRegular = await fetch(`{{this.urls.GET_USER_CHART_DATA_URL}}`);
        const dataRegular = await responseRegular.json();
        labels = dataRegular.label;
        dataRegularBook = dataRegular.data;

        const responseAuction = await fetch(`{{this.urls.GET_AUCTION_BOOK_DATA_CHART_URL}}`);
        const dataAuction = await responseAuction.json();
        dataAuctionBook = dataAuction.data;

        return { labels, dataRegularBook, dataAuctionBook };
    }

    async function getBillData() {
        const responseBill = await fetch(`{{this.urls.GET_BILL_USER_URL}}`);
        dataBill = await responseBill.json();
    }

    async function getThreeBillData() {
        const responseThreeBill = await fetch(`{{this.urls.GET_BILL_THREE_USER_URL}}`);
        dataThreeBill = await responseThreeBill.json(); // Lưu dữ liệu đơn hoàn thành vào biến dataThreeBill
    }

    window.onload = function () {
        Promise.all([getRegularAndAuctionBookData(), getBillData(), getThreeBillData()]).then(([value]) => {
            const formattedLabels = value.labels.map(formatDate);
            GroupedbarChartData = {
                labels: formattedLabels,
                datasets: [
                    {
                        label: "Sách bán",
                        backgroundColor: "pink",
                        borderColor: "pink",
                        borderWidth: 1,
                        data: value.dataRegularBook,
                    },
                    {
                        label: "Sách đấu giá",
                        backgroundColor: "blue",
                        borderColor: "blue",
                        borderWidth: 1,
                        data: value.dataAuctionBook,
                    },
                    {
                        label: "Tổng",
                        backgroundColor: "green",
                        borderColor: "green",
                        borderWidth: 1,
                        data: value.dataRegularBook.map((count, index) => count + value.dataAuctionBook[index]),
                    },
                ],
            };

            var chartData = {
                type: "bar",
                data: GroupedbarChartData,
            };

            new Chart("BookGroupedbarChartcanvas", chartData);

            // Tạo biểu đồ DonHang
            var DonHang = {
                labels: formattedLabels,
                datasets: [
                    {
                        label: "Đơn gửi đi",
                        backgroundColor: "blue",
                        borderColor: "blue",
                        borderWidth: 1,
                        data: dataBill.data,
                    },
                    {
                        label: "Đơn hoàn thành",
                        backgroundColor: "orange",
                        borderColor: "orange",
                        borderWidth: 1,
                        data: dataThreeBill.data, // Sử dụng dữ liệu đơn hoàn thành ở đây cho cột "Đơn hoàn thành"
                    },
                    {
                        label: "Tổng",
                        backgroundColor: "grey",
                        borderColor: "grey",
                        borderWidth: 1,
                        data: dataBill.data.map((count, index) => count + dataThreeBill.data[index]),
                    },
                ],
            };

            var chartDatas = {
                type: "bar",
                data: DonHang,
                // options: BarchartOptions
            }
            new Chart("DonHang", chartDatas);
        });
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="js/scripts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js" crossorigin="anonymous"></script>
<script src="assets/demo/chart-bar-demo.js"></script>

<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" crossorigin="anonymous"></script>
<script src="js/datatables/datatables-simple-demo.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js" crossorigin="anonymous"></script>
<script src="js/litepicker.js"></script>

</body>
</html>